<div class="post-body">
  <h2 id="目的">目的</h2>
  <p>この記事では、以下のVPS環境でDjangoサイトを構築するために必要な「データベース設定と起動確認手順」について説明する。</p>
  <ul>
    <li>OS：CentOS 7,4</li>
    <li>言語：Python</li>
    <li>WEBサーバー：Apache</li>
    <li>FW：Django</li>
    <li>DB：PostgresSQL</li>
    <li>ドメイン：example.com</li>
  </ul>
  <h2 id="実施内容">実施内容</h2>
  <h3 id="データベースの環境構築">データベースの環境構築</h3>
  <ul>
    <li>
      <p>PostgreSQLインストール</p>
      <pre><code>yum -y install postgresql-server 
</code></pre>
    </li>
    <li>
      <p>データベースとユーザーの作成<br>
        データベース<code>MACUOSDB</code>とアクセスユーザー<code>padmin</code>を作成。</p>
      <pre><code>$ postgresql-setup initdb # データベースの初期化
$ service postgresql start # PostgreSqlを起動
$ sudo -u postgres psql # postgresでログイン
postgres=# CREATE DATABASE MACUOSDB; # データベースの作成
postgres=# CREATE USER padmin WITH PASSWORD '*****'; # ユーザー、パスワードの作成
postgres=# ALTER ROLE padmin SET client_encoding TO 'utf8'; # padminの文字コードを設定
postgres=# ALTER ROLE padmin SET default_transaction_isolation TO 'read committed';  # 実行された結果だけを見に行く
postgres=# ALTER ROLE padmin SET timezone TO 'UTC+9'; # タイムゾーンを設定
postgres=# GRANT ALL PRIVILEGES  ON DATABASE MACUOSDB TO admin;  # padminに権限を付与
</code></pre>
    </li>
    <li>
      <p>PostgreSqlを起動確認<br>
        active (running) と表示されていれば成功。</p>
      <pre><code>$ service postgresql status
</code></pre>
    </li>
  </ul>
  <h3 id="django周りの設定">Django周りの設定</h3>
  <p>以下、Djangoのモデル定義が終わっていることが前提。</p>
  <ul>
    <li>
      <p>マイグレーションファイルを作成<br>
        ※ マイグレーションファイル(モデルの内容をデータベースに適用するファイル)<br></p>
      <pre><code>$ /var/www/vops/ops/manage.py makemigrations
</code></pre>
    </li>
    <li>
      <p>マイグレーションファイルをデータベースに反映<br>
        マイグレーションファイルを基に、データベースの構造(テーブルの作成や更新)を変更する。</p>
      <pre><code>$ /var/www/vops/ops/manage.py migrate
</code></pre>
    </li>
    <li>
      <p>スーパーユーザーの作成<br></p>
      <pre><code>$ /var/www/vops/ops/manage.py createsuperuser
</code></pre>
    </li>
    <li>
      <p>staticファイルの設定、収集<br>
        <code>settings.py</code>に<code>STATIC_ROOT</code>を定義する。<br>
        <code>collectstatic</code>により、このパスへ静的ファイルが収集される。
      </p>
      <pre><code>$ vim /var/www/vops/ops/ops/settings.py
# STATIC_ROOT = os.path.join(BASE_DIR, &quot;static/&quot;) ← この行を追記
$ /var/www/vops/ops/manage.py collectstatic
</code></pre>
    </li>
    <li>
      <p>Djangoのポートを解放<br>
        Djangoで使用するポートを解放する。<br>
        ※ ここでは開発用として8080を解放する。</p>
      <pre><code># firewall-cmd --permanent --add-port=8080/tcp
# firewall-cmd --reload
</code></pre>
    </li>
    <li>
      <p>プロジェクトのドメイン設定<br></p>
      <ul>
        <li><code>settings.py</code>の<code>ALLOWED_HOST</code>にドメインを設定</li>
      </ul>
      <pre><code># firewall-cmd --permanent --add-port=8080/tcp
# firewall-cmd --reload
</code></pre>
      <ul>
        <li><code>settings.py</code>に<code>STATIC_ROOT</code>を定義<br>
          ※ collectstaticにより、このパスへ静的ファイルが収集されるようになる。</li>
      </ul>
      <pre><code>$ vim /var/www/vops/ops/ops/settings.py 
# ALLOWED_HOSTS = ['example.com']を指定する。
</code></pre>
    </li>
  </ul>
  <h3 id="postgresql周りの設定">PostgreSql周りの設定</h3>
  <ul>
    <li>
      <p><code>postgresql.conf</code>の<code>listen_addresses</code>を公開</p>
      <pre><code>$ vim /var/lib/pgsql/data/postgresql.conf
listen_addresses = '*' # localhostを*に修正。 
</code></pre>
    </li>
    <li>
      <p><code>pg_hba.conf(認証設定ファイル)</code>にドメイン情報を追加<br>
        IPアドレスは、サーバーのものを指定する。
        その他項目については、公式文章を参照。
        <a
          href="https://www.postgresql.jp/document/9.2/html/auth-pg-hba-conf.html">https://www.postgresql.jp/document/9.2/html/auth-pg-hba-conf.html</a>
      </p>
      <pre><code>$ vim /var/lib/pgsql/data/pg_hba.conf
# 下記を追記
host    all             all             XXX.XXX.XXX.XXX/32        md5
</code></pre>
    </li>
    <li>
      <p>firewallの設定<br>
        ポート5432を解放する。</p>
      <pre><code>$ firewall-cmd --add-port=5432/tcp --zone=public --permanent # portを解放
$ firewall-cmd --reload # 再読込
</code></pre>
    </li>
  </ul>
</div>
